= Workers
:idprefix:
:idseparator: -
:sectlinks:
:toc: auto
:toclevels: 4

:uri-oke-ol7-images: https://docs.oracle.com/en-us/iaas/images/oke-worker-node-oracle-linux-7x
:uri-oke-ol8-images: https://docs.oracle.com/en-us/iaas/images/oke-worker-node-oracle-linux-8x

:uri-docs-cloud-init: link:cloud_init.adoc#configuring-cloud-init
:uri-docs-ext-ca: link:extensions.adoc#ext_ca
:uri-oci-fss-pvc: https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengcreatingpersistentvolumeclaim.htm#Provisioning_Persistent_Volume_Claims_on_the_FileStorageService

== General
The `<<input_worker_pools,worker_pools>>` input defines worker node configuration for the cluster.

Many of the global configuration values below may be overridden on each pool definition or omitted for defaults, with the `worker_` or `worker_pool_` variable prefix removed, e.g. `worker_image_id` overridden with `image_id`.

.General worker tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_cluster_ca_cert]] <<input_cluster_ca_cert,cluster_ca_cert>>
|Base64+PEM-encoded cluster CA certificate for unmanaged instance pools. Determined automatically when 'create_cluster' = true or 'cluster_id' is provided.
|`string`
|`null`
|no

|[[input_worker_block_volume_type]] <<input_worker_block_volume_type,worker_block_volume_type>>
|Default block volume attachment type for Instance Configurations when unspecified on a pool.
|`string`
|`"paravirtualized"`
|no

|[[input_worker_compartment_id]] <<input_worker_compartment_id,worker_compartment_id>>
|The compartment id where worker group resources will be created.
|`string`
|`null`
|no

|[[input_worker_is_public]] <<input_worker_is_public,worker_is_public>>
|Whether to provision workers with public IPs allocated by default when unspecified on a pool.
|`bool`
|`false`
|no

|[[input_worker_node_labels]] <<input_worker_node_labels,worker_node_labels>>
|Default worker node labels. Merged with labels defined on each pool.
|`map(string)`
|`{}`
|no

|[[input_worker_pools]] <<input_worker_pools,worker_pools>>
|Tuple of OKE worker pools where each key maps to the OCID of an OCI resource, and value contains its definition.
|`any`
|`{}`
|no

|[[input_worker_pv_transit_encryption]] <<input_worker_pv_transit_encryption,worker_pv_transit_encryption>>
|Whether to enable in-transit encryption for the data volume's paravirtualized attachment by default when unspecified on a pool.
|`bool`
|`false`
|no

|[[input_worker_node_metadata]] <<input_worker_node_metadata,worker_node_metadata>>
|Map of additional worker node instance metadata. Merged with metadata defined on each pool.
|`map(string)`
|`{}`
|no

|[[input_worker_nsg_ids]] <<input_worker_nsg_ids,worker_nsg_ids>>
|An additional list of network security group (NSG) IDs for node security. Combined with 'nsg_ids' specified on each pool.
|`list(string)`
|`[]`
|no

|[[input_worker_pool_mode]] <<input_worker_pool_mode,worker_pool_mode>>
|Default management mode for workers when unspecified on a pool. Only 'node-pool' is currently supported.
|`string`
|`"node-pool"`
|no

|[[input_worker_pool_size]] <<input_worker_pool_size,worker_pool_size>>
|Default size for worker pools when unspecified on a pool.
|`number`
|`0`
|no

|[[input_worker_shape]] <<input_worker_shape,worker_shape>>
|Default shape of the created worker instance when unspecified on a pool.
|`map(any)`
|

[source]
----
{
  "boot_volume_size": 50,
  "memory": 16,
  "ocpus": 2,
  "shape": "VM.Standard.E4.Flex"
}
----

|no

|[[input_worker_volume_kms_key_id]] <<input_worker_volume_kms_key_id,worker_volume_kms_key_id>>
|The ID of the OCI KMS key to be used as the master encryption key for Boot Volume and Block Volume encryption by default when unspecified on a pool.
|`string`
|`null`
|no

|===

== Mode

The `mode` parameter controls the type of resources provisioned in OCI for OKE worker nodes.

NOTE: The only `mode` value currently supported is `node-pool`.

=== OKE-managed

==== `mode = "node-pool"`

.A standard OKE-managed pool of worker nodes with enhanced feature support:
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/containerengine_node_pool[oci_containerengine_node_pool]
* https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengmodifyingnodepool.htm[Modifying Node Pool and Worker Node Properties]
* https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengscalingclusters.htm[Adding and Removing Node Pools]

=== Self-managed

NOTE: Pending availability; contact us for more information.

==== `mode = "instance"`

.A set of self-managed instances for custom user-provisioned worker nodes not managed by an OCI pool, but individually by Terraform:
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/core_instance[oci_core_instance]

.See also:
* https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/launchinginstance.htm[Creating an Instance]

==== `mode = "instance-pool"`

.A self-managed instance pool for custom user-provisioned worker nodes:
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/core_instance_configuration[oci_core_instance_configuration]
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/core_instance_pool[oci_core_instance_pool]

.See also:
* https://docs.oracle.com/en-us/iaas/Content/Compute/Concepts/instancemanagement.htm[Using Instance Configurations and Instance Pools]

==== `mode = "cluster-network"`

.A self-managed instance pool with Cluster Networks integration:
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/core_instance_configuration[oci_core_instance_configuration]
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/core_cluster_network[oci_core_cluster_network]

.See also:
* https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/managingclusternetworks.htm#Managing_Cluster_Networks[Cluster Networks with Instance Pools]
* https://blogs.oracle.com/cloud-infrastructure/post/large-clusters-lowest-latency-cluster-networking-on-oracle-cloud-infrastructure[Large Clusters, Lowest Latency: Cluster Networking on Oracle Cloud Infrastructure]
* https://blogs.oracle.com/cloud-infrastructure/post/building-high-performance-network-in-the-cloud[First principles: Building a high-performance network in the public cloud]
* https://blogs.oracle.com/cloud-infrastructure/post/running-applications-on-oracle-cloud-using-cluster-networking[Running Applications on Oracle Cloud Using Cluster Networking]

== Cloud Init

See {uri-docs-cloud-init}[Cloud Init].

== Image

The OS image for worker nodes.

.OKE-optimized:
* {uri-oke-ol7-images}[Oracle Linux 7.x]
* {uri-oke-ol8-images}[Oracle Linux 8.x]

.Worker OS image tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_worker_image_id]] <<input_worker_image_id,worker_image_id>>
|Default image for worker pools  when unspecified on a pool.
|`string`
|`null`
|no

|[[input_worker_image_os]] <<input_worker_image_os,worker_image_os>>
|Default worker image operating system name when worker_image_type = 'oke' or 'platform' and unspecified on a pool.
|`string`
|`"Oracle Linux"`
|no

|[[input_worker_image_os_version]] <<input_worker_image_os_version,worker_image_os_version>>
|Default worker image operating system version when worker_image_type = 'oke' or 'platform' and unspecified on a pool.
|`string`
|`"8"`
|no

|[[input_worker_image_type]] <<input_worker_image_type,worker_image_type>>
|Whether to use a platform, OKE, or custom image for worker nodes by default when unspecified on a pool. When custom is set, the worker_image_id must be specified.
|`string`
|`"oke"`
|no

|===

== File Storage

NOTE: TODO Pending validation for 5.x

* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/file_storage_export[oci_file_storage_export.fss]
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/file_storage_export_set[oci_file_storage_export_set.fss]
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/file_storage_file_system[oci_file_storage_file_system.fss]
* https://registry.terraform.io/providers/oracle/oci/latest/docs/resources/file_storage_mount_target[oci_file_storage_mount_target.fss]

The File Storage service instance will be created in a separate subnet with access configured using a network security group.

You can then review the following documentation for creating persistent volume claim and persistent volume using file storage

.See also:
* {uri-oci-fss-pvc}[Provisioning PV and PVC using FSS]

CAUTION: Running terraform destroy will remove the filesystem storage created using Terraform. Ensure you have taken the necessary backup if needed.

.Worker FSS tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_create_fss]] <<input_create_fss,create_fss>>
|Whether to enable provisioning for FSS.
|`bool`
|`false`
|no

|[[input_fss_availability_domain]] <<input_fss_availability_domain,fss_availability_domain>>
|The availability domain for FSS placement. Defaults to first available.
|`string`
|`null`
|no

|[[input_fss_max_fs_stat_bytes]] <<input_fss_max_fs_stat_bytes,fss_max_fs_stat_bytes>>
|Maximum tbytes, fbytes, and abytes, values reported by NFS FSSTAT calls through any associated mount targets.
|`number`
|`23843202333`
|no

|[[input_fss_max_fs_stat_files]] <<input_fss_max_fs_stat_files,fss_max_fs_stat_files>>
|Maximum tfiles, ffiles, and afiles values reported by NFS FSSTAT.
|`number`
|`223442`
|no

|[[input_fss_mount_path]] <<input_fss_mount_path,fss_mount_path>>
|FSS mount path to be associated.
|`string`
|`"/oke_fss"`
|no

|[[input_fss_nsg_ids]] <<input_fss_nsg_ids,fss_nsg_ids>>
|A list of network security group (NSG) ids for FSS mount targets.
|`list(string)`
|`[]`
|no

|===

== Scaling

.There are two easy ways to add worker nodes to a cluster:
* add entries to `worker_pools`
* increase the `size` of a `worker_pools` entry

Worker pools can be added and removed, their size and boot volume size can be updated. After each change, run `terraform apply`.

Scaling changes to the number and size of pools are immediate after changing the parameters and running `terraform apply`. The changes to boot volume size will only be effective in newly created nodes _after_ the change is completed.

== Autoscaling

See {uri-docs-ext-ca}[Extensions/Cluster Autoscaler].

== Draining

NOTE: TODO