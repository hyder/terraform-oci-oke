= Operator
:idprefix:
:idseparator: -
:sectlinks:
:toc: auto
:toclevels: 4

:uri-oci-instance-principal: https://docs.cloud.oracle.com/iaas/Content/Identity/Tasks/callingservicesfrominstances.htm

:uri-oci-ol7-images: https://docs.oracle.com/en-us/iaas/images/autonomous-linux-7x
:uri-oci-ol8-images: https://docs.oracle.com/en-us/iaas/images/autonomous-linux-8x

The operator instance provides an optional environment within the VCN from which the OKE cluster can be managed.

== General

.The operator host parameters concern:
. whether you want to enable the operator
. from where you can access the operator
. the different parameters about the operator host e.g. shape, image id etc.

.Operator tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_create_operator]] <<input_create_operator,create_operator>>
|Whether to create an operator server in a private subnet.
|`bool`
|`true`
|no

|[[input_operator_shape]] <<input_operator_shape,operator_shape>>
|Shape of the created operator instance.
|`map(any)`
|
[source]
----
{
  "boot_volume_size": 50,
  "memory": 4,
  "ocpus": 1,
  "shape": "VM.Standard.E4.Flex"
}
----

|no

|[[input_operator_availability_domain]] <<input_operator_availability_domain,operator_availability_domain>>
|The availability domain for FSS placement. Defaults to first available.
|`string`
|`null`
|no

|[[input_operator_volume_kms_key_id]] <<input_operator_volume_kms_key_id,operator_volume_kms_key_id>>
|The OCID of the OCI KMS key to assign as the master encryption key for the boot volume.
|`string`
|`null`
|no

|===

== Cloud Init

Custom startup configuration for the created operator instance.

.Operator cloud-init tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_operator_cloud_init]] <<input_operator_cloud_init,operator_cloud_init>>
|List of maps containing cloud init MIME part configuration for operator host. See https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/cloudinit_config.html#part for expected schema of each element.
|`list(map(string))`
|`[]`
|no

|[[input_operator_install_helm]] <<input_operator_install_helm,operator_install_helm>>
|Whether to install Helm on the created operator host.
|`bool`
|`true`
|no

|[[input_operator_install_k9s]] <<input_operator_install_k9s,operator_install_k9s>>
|Whether to install k9s on the created operator host. NOTE: Provided only as a convenience and not supported by or sourced from Oracle - use at your own risk.
|`bool`
|`false`
|no

|[[input_operator_install_kubectx]] <<input_operator_install_kubectx,operator_install_kubectx>>
|Whether to install kubectx/kubens on the created operator host. NOTE: Provided only as a convenience and not supported by or sourced from Oracle - use at your own risk.
|`bool`
|`true`
|no

|[[input_operator_upgrade]] <<input_operator_upgrade,operator_upgrade>>
|Whether to upgrade operator packages after provisioning.
|`bool`
|`false`
|no

|[[input_operator_user]] <<input_operator_user,operator_user>>
|User for SSH access to operator host.
|`string`
|`"opc"`
|no

|===

== Image

The OS image for the created operator instance.

.See also:
* {uri-oci-ol7-images}[Oracle Linux 7.x]
* {uri-oci-ol8-images}[Oracle Linux 8.x]

.Operator image tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_operator_image_id]] <<input_operator_image_id,operator_image_id>>
|Image ID for created operator instance.
|`string`
|`null`
|no

|[[input_operator_image_os]] <<input_operator_image_os,operator_image_os>>
|Operator image operating system name when operator_image_type = 'platform'.
|`string`
|`"Oracle Linux"`
|no

|[[input_operator_image_os_version]] <<input_operator_image_os_version,operator_image_os_version>>
|Operator image operating system version when operator_image_type = 'platform'.
|`string`
|`"8"`
|no

|[[input_operator_image_type]] <<input_operator_image_type,operator_image_type>>
|Whether to use a platform or custom image for the created operator instance. When custom is set, the operator_image_id must be specified.
|`string`
|`"platform"`
|no

|===

== Networking

.Bastion networking tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_operator_nsg_ids]] <<input_operator_nsg_ids,operator_nsg_ids>>
|An optional and updatable list of network security groups that the operator will be part of.
|`list(string)`
|`[]`
|no

|[[input_operator_private_ip]] <<input_operator_private_ip,operator_private_ip>>
|The IP address of an existing operator host. Ignored when create_operator = true.
|`string`
|`null`
|no

|[[input_operator_pv_transit_encryption]] <<input_operator_pv_transit_encryption,operator_pv_transit_encryption>>
|Whether to enable in-transit encryption for the data volume's paravirtualized attachment.
|`bool`
|`false`
|no

|===

== SSH

.Command usage for `ssh` through the created bastion to the operator host is included in the module's output:
[source]
----
$ terraform output
cluster = {
  "bastion_public_ip" = "138.0.0.1"
  "ssh_to_operator" = "ssh -J opc@138.0.0.1 opc@10.0.0.16"
  ...
  }
}

$ ssh -J opc@138.0.0.1 opc@10.0.0.16 kubectl get nodes
NAME          STATUS   ROLES    AGE     VERSION
10.1.48.175   Ready    node     7d10h   v1.25.6
10.1.50.102   Ready    node     3h12m   v1.25.6
10.1.52.76    Ready    node     7d10h   v1.25.6
10.1.54.237   Ready    node     5h41m   v1.25.6
10.1.58.74    Ready    node     5h22m   v1.25.4
10.1.62.90    Ready    node     3h12m   v1.25.6
----

== Identity

=== Using instance_principal on the operator host
{uri-oci-instance-principal}[instance_principal] is an IAM service feature that enables instances to be authorized actors (or principals) to perform actions on service resources. Each compute instance has its own identity, and it authenticates using the certificates that are added to it. These certificates are automatically created, assigned to instances and rotated, preventing the need for you to distribute credentials to your hosts and rotate them.

Any user who has access to the instance (who can SSH to the instance), automatically inherits the privileges granted to the instance. Before you enable this feature, ensure that you know who can access it, and that they should be authorized with the permissions you are granting to the instance.

By default, this feature is *_disabled_*. However, it is *_required_* at the time of cluster creation *_if_* you wish to enable link:#kms-integration[KMS Integration], calico, metricserver or creating the OCIR secret.

When you enable this feature, by default, the operator host will have privileges to all resources in the compartment. If you are enabling it for link:#kms-integration[KMS Integration], the operator host will also have rights to create policies in the root tenancy. 

You can also turn on and off the feature at any time without impact on the operator or the cluster.
