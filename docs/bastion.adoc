= Bastion
:idprefix:
:idseparator: -
:sectlinks:
:toc: auto
:toclevels: 4

:uri-ca-github: # https://github.com/kubernetes/autoscaler/tree/master/charts/cluster-autoscaler
:uri-ca-oracle: # https://docs.oracle.com/en-us/iaas/Content/ContEng/Tasks/contengautoscalingclusters.htm
:uri-gatekeeper: https://open-policy-agent.github.io/gatekeeper

:uri-oci-ol7-images: https://docs.oracle.com/en-us/iaas/images/autonomous-linux-7x
:uri-oci-ol8-images: https://docs.oracle.com/en-us/iaas/images/autonomous-linux-8x

The bastion instance provides a public SSH entrypoint into the VCN from which resources in private subnets may be accessed - recommended to limit public IP usage and exposure.

== General

.The bastion host parameters concern:
. whether you want to enable the bastion
. from where you can access the bastion
. the different parameters about the bastion host e.g. shape, image id etc.

.Bastion tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_bastion_availability_domain]] <<input_bastion_availability_domain,bastion_availability_domain>>
|The availability domain for bastion placement. Defaults to first available.
|`string`
|`null`
|no

|[[input_bastion_shape]] <<input_bastion_shape,bastion_shape>>
|The shape of bastion instance.
|`map(any)`
|

[source]
----
{
  "boot_volume_size": 50,
  "memory": 4,
  "ocpus": 1,
  "shape": "VM.Standard.E4.Flex"
}
----

|no

|[[input_bastion_upgrade]] <<input_bastion_upgrade,bastion_upgrade>>
|Whether to upgrade bastion packages after provisioning.
|`bool`
|`false`
|no

|[[input_bastion_user]] <<input_bastion_user,bastion_user>>
|User for SSH access through bastion host.
|`string`
|`"opc"`
|no

|===

== Cloud Init

Custom startup configuration for the created bastion instance.

.Bastion cloud-init tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_bastion_cloud_init]] <<input_bastion_cloud_init,bastion_cloud_init>>
|List of maps containing cloud init MIME part configuration for the created bastion host. See https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/cloudinit_config.html#part[template_cloudinit_config] for expected schema of each element.
|`list(map(string))`
|`[]`
|no

|===

== Image

The OS image for the created bastion instance.

.See also:
* {uri-oci-ol7-images}[Oracle Autonomous Linux 7.x]
* {uri-oci-ol8-images}[Oracle Autonomous Linux 8.x]

.Bastion image tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_bastion_image_id]] <<input_bastion_image_id,bastion_image_id>>
|Image ID for created bastion instance.
|`string`
|`null`
|no

|[[input_bastion_image_os]] <<input_bastion_image_os,bastion_image_os>>
|Bastion image operating system name when bastion_image_type = 'platform'.
|`string`
|`"Oracle Autonomous Linux"`
|no

|[[input_bastion_image_os_version]] <<input_bastion_image_os_version,bastion_image_os_version>>
|Bastion image operating system version when bastion_image_type = 'platform'.
|`string`
|`"8.7"`
|no

|[[input_bastion_image_type]] <<input_bastion_image_type,bastion_image_type>>
|Whether to use a platform or custom image for the created bastion instance. When custom is set, the bastion_image_id must be specified.
|`string`
|`"platform"`
|no

|===

== Networking

.Bastion networking tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_bastion_allowed_cidrs]] <<input_bastion_allowed_cidrs,bastion_allowed_cidrs>>
|A list of CIDR blocks to allow SSH access to the bastion host.
|`list(string)`
|

[source]
----
[
  "0.0.0.0/0"
]
----

|no

|[[input_bastion_nsg_ids]] <<input_bastion_nsg_ids,bastion_nsg_ids>>
|An additional list of network security group (NSG) IDs for bastion security.
|`list(string)`
|`[]`
|no

|[[input_bastion_is_public]] <<input_bastion_is_public,bastion_is_public>>
|Whether to create allocate a public IP and subnet for the created bastion host.
|`bool`
|`true`
|no

|[[input_bastion_public_ip]] <<input_bastion_public_ip,bastion_public_ip>>
|The IP address of an existing bastion host, if create_bastion = false.
|`string`
|`null`
|no

|===

== SSH

.Command usage for `ssh` through the created bastion to the operator host is included in the module's output:
[source]
----
$ terraform output
cluster = {
  "bastion_public_ip" = "138.0.0.1"
  "ssh_to_operator" = "ssh -J opc@138.0.0.1 opc@10.0.0.16"
  ...
  }
}

$ ssh -J opc@138.0.0.1 opc@10.0.0.16 kubectl get nodes
NAME          STATUS   ROLES    AGE     VERSION
10.1.48.175   Ready    node     7d10h   v1.25.6
10.1.50.102   Ready    node     3h12m   v1.25.6
10.1.52.76    Ready    node     7d10h   v1.25.6
10.1.54.237   Ready    node     5h41m   v1.25.6
10.1.58.74    Ready    node     5h22m   v1.25.4
10.1.62.90    Ready    node     3h12m   v1.25.6

$ ssh -J opc@138.0.0.1 opc@10.1.54.237 systemctl status kubelet
‚óè kubelet.service - Kubernetes Kubelet
     Active: active (running) since Tue 2023-03-28 01:48:08 UTC; 5h 48min ago
...
----
