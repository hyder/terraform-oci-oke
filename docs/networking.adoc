= Networking
:idprefix:
:idseparator: -
:sectlinks:
:toc: auto
:toclevels: 4

:uri-oci-network: https://docs.oracle.com/en-us/iaas/Content/Network/Concepts/overview.htm
:uri-oci-vcns: https://docs.oracle.com/en-us/iaas/Content/Network/Tasks/VCNs.htm

:uri-repo: https://github.com/oracle-terraform-modules/terraform-oci-oke

:uri-oci-waf: https://docs.cloud.oracle.com/en-us/iaas/Content/WAF/Concepts/overview.htm
:uri-oci-waf-certificate: https://docs.cloud.oracle.com/en-us/iaas/Content/WAF/Concepts/gettingstarted.htm#upload
:uri-oci-waf-dns: https://docs.cloud.oracle.com/en-us/iaas/Content/WAF/Concepts/gettingstarted.htm#update
:uri-oci-waf-policy: https://docs.cloud.oracle.com/en-us/iaas/Content/WAF/Concepts/gettingstarted.htm#create
:uri-oci-waf-tutorial: https://www.youtube.com/watch?v=CfoK9JjBxts

:uri-rel-file-base: link:{uri-repo}/blob/main
:uri-rel-tree-base: link:{uri-repo}/tree/main

:uri-ig-docs: https://docs.oracle.com/en-us/iaas/Content/Network/Tasks/managingIGs.htm
:uri-nat-docs: https://docs.oracle.com/en-us/iaas/Content/Network/Tasks/NATgateway.htm

== Virtual Cloud Network (VCN)

.See also:
* {uri-oci-network}[Networking Overview]
* {uri-oci-vcns}[VCNs and Subnets]
* {uri-networks-subnets-cidr}[Erik Berg on Networks, Subnets and CIDR]

.VCN tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_create_vcn]] <<input_create_vcn,create_vcn>>
|Whether to create a Virtual Cloud Network.
|`bool`
|`true`
|no

|[[input_vcn_name]] <<input_vcn_name,vcn_name>>
|Name of created VCN when `create_vcn = true`, or optional filter when `create_vcn = false`.
|`string`
|`"oke"`
|no

|[[input_internet_gateway_route_rules]] <<input_internet_gateway_route_rules,internet_gateway_route_rules>>
|(Updatable) List of routing rules to add to Internet Gateway Route Table.
|`list(map(string))`
|`null`
|no

|[[input_lockdown_default_seclist]] <<input_lockdown_default_seclist,lockdown_default_seclist>>
|Whether to remove all default security rules from the VCN Default Security List.
|`bool`
|`true`
|no

|[[input_nat_gateway_route_rules]] <<input_nat_gateway_route_rules,nat_gateway_route_rules>>
|(Updatable) List of routing rules to add to NAT Gateway Route Table.
|`list(map(string))`
|`null`
|no

|[[input_nat_gateway_public_ip_id]] <<input_nat_gateway_public_ip_id,nat_gateway_public_ip_id>>
|OCID of reserved IP address for NAT gateway. The reserved public IP address needs to be manually created.
|`string`
|`null`
|no

|[[input_local_peering_gateways]] <<input_local_peering_gateways,local_peering_gateways>>
|Map of Local Peering Gateways to attach to the VCN.
|`map(any)`
|`null`
|no

|===


=== New (`create_vcn = true`)
The module will create and manage a VCN by default with NAT and internet gateways for a typical configuration.

.VCN tfvars (new)
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_vcn_cidrs]] <<input_vcn_cidrs,vcn_cidrs>>
|The list of IPv4 CIDR blocks the VCN will use.
|`list(string)`
|

[source]
----
[
  "10.0.0.0/16"
]
----

|no

|[[input_assign_dns]] <<input_assign_dns,assign_dns>>
|Whether to assign DNS records to created resources.
|`bool`
|`true`
|no

|[[input_vcn_dns_label]] <<input_vcn_dns_label,vcn_dns_label>>
|A DNS label for the VCN, used in conjunction with the VNIC's hostname and subnet's DNS label to form a fully qualified domain name (FQDN) for each VNIC within this subnet. DNS resolution of hostnames in the VCN is disabled when null.
|`string`
|`"oke"`
|no

|===

=== Existing (`create_vcn = false`)
VCN creation may be optionally disabled to use existing resources.

NOTE: Assumes VCN has been created with an Internet Gateway, NAT Gateway, and Service Gateway and appropriate route tables.

The {uri-ig-docs}[Internet Gateway] route table should have a minimum route with destination CIDR  `0.0.0.0/0` and target as `Internet Gateway`.

The {uri-nat-docs}[NAT Gateway] route table should have a minimum route with destination CIDR to `0.0.0.0/0` or specific CIDR as per your network requirement and target as `NAT Gateway`.

.VCN tfvars (existing)
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_vcn_id]] <<input_vcn_id,vcn_id>>
|Optional ID of existing VCN. Takes priority over vcn_name filter. Ignored when `create_vcn = true`.
|`string`
|`null`
|no

|[[input_ig_route_table_id]] <<input_ig_route_table_id,ig_route_table_id>>
|Optional ID of existing internet gateway in VCN.
|`string`
|`null`
|no

|[[input_nat_route_table_id]] <<input_nat_route_table_id,nat_route_table_id>>
|Optional ID of existing NAT gateway in VCN.
|`string`
|`null`
|no

|===

== Subnets

.See also:
* Terraform `https://developer.hashicorp.com/terraform/language/functions/cidrsubnets[cidrsubnets]` function

.Subnet tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_subnets]] <<input_subnets,subnets>>
|Default subnet configuration.
|`any`
|

[source]
----
{
  "bastion": { "create": "auto", "newbits": 13 },
  "cp": { "create": "auto", "newbits": 13 },
  "fss": { "create": "auto", "newbits": 11 },
  "int_lb": { "create": "auto", "newbits": 11 },
  "operator": { "create": "auto", "newbits": 13 },
  "pods": { "create": "auto", "newbits": 2 },
  "pub_lb": { "create": "auto", "newbits": 11 },
  "workers": { "create": "auto", "newbits": 2 }
}
----
| no

|===

== Network Security Groups (NSGs)

Network communication is allowed between resources created by the module using NSG rules.

.See also:
* https://docs.oracle.com/en-us/iaas/Content/Network/Concepts/networksecuritygroups.htm[Network Security Groups]
* https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengnetworkconfig.htm#securitylistconfig[Security Rule Configuration in ... Network Security Groups]

.NSG tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_create_nsgs]] <<input_create_nsgs,create_nsgs>>
|Whether to create standard network security groups.
|`bool`
|`true`
|no

|[[input_create_nsgs_always]] <<input_create_nsgs_always,create_nsgs_always>>
|Whether to create standard network security groups when associated components will not be.
|`bool`
|`false`
|no

|[[input_bastion_nsg_ids]] <<input_bastion_nsg_ids,bastion_nsg_ids>>
|An additional list of network security group (NSG) IDs for bastion security.
|`list(string)`
|`[]`
|no

|[[input_pod_nsg_ids]] <<input_pod_nsg_ids,pod_nsg_ids>>
|An additional list of network security group (NSG) IDs for pod security. Combined with 'pod_nsg_ids' specified on each pool.
|`list(string)`
|`[]`
|no

|[[input_worker_nsg_ids]] <<input_worker_nsg_ids,worker_nsg_ids>>
|An additional list of network security group (NSG) IDs for node security. Combined with 'nsg_ids' specified on each pool.
|`list(string)`
|`[]`
|no

|[[input_allow_node_port_access]] <<input_allow_node_port_access,allow_node_port_access>>
|Whether to allow access from worker NodePort range to load balancers.
|`bool`
|`false`
|no

|[[input_allow_pod_internet_access]] <<input_allow_pod_internet_access,allow_pod_internet_access>>
|Allow pods to egress to internet. Ignored when cni_type != 'npn'.
|`bool`
|`true`
|no

|[[input_allow_worker_internet_access]] <<input_allow_worker_internet_access,allow_worker_internet_access>>
|Allow worker nodes to egress to internet. Required if container images are in a registry other than OCIR.
|`bool`
|`true`
|no

|[[input_allow_worker_ssh_access]] <<input_allow_worker_ssh_access,allow_worker_ssh_access>>
|Whether to allow SSH access to worker nodes.
|`bool`
|`false`
|no

|===

== Container Network Interface (CNI)

.See also:
* https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengpodnetworking.htm[Pod Networking]

=== Base

.Cluster CNI tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_cni_type]] <<input_cni_type,cni_type>>
|The CNI for the cluster: 'flannel' or 'npn'. See https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengpodnetworking.htm.
|`string`
|`"flannel"`
|no

|===

==== Flannel (`cni_type = "flannel"`)

_See https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengpodnetworking_topic-flannel_CNI_plugin.htm[Using the flannel CNI plugin for pod networking]._

.Flannel CNI tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_pods_cidr]] <<input_pods_cidr,pods_cidr>>
|The CIDR range used for IP addresses by the pods. A /16 CIDR is generally sufficient. This CIDR should not overlap with any subnet range in the VCN (it can also be outside the VCN CIDR range). Ignored when cni_type = 'npn'.
|`string`
|`"10.244.0.0/16"`
|no

|===

==== VCN-Native (`cni_type = "npn"`)

_See https://docs.oracle.com/en-us/iaas/Content/ContEng/Concepts/contengpodnetworking_topic-OCI_CNI_plugin.htm[Using the OCI VCN-Native Pod Networking CNI plugin for pod networking]._

.VCN-Native CNI tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_max_pods_per_node]] <<input_max_pods_per_node,max_pods_per_node>>
|The default maximum number of pods to deploy per node when unspecified on a pool. Absolute maximum is 110. Ignored when when cni_type != 'npn'.
|`number`
|`31`
|no

|===

=== Extensions

==== Calico (`calico_enabled = true`)

NOTE: Pending validation on 5.x

[[net_calico]] _See https://docs.tigera.io/calico/latest/getting-started[Install Calico]._

.Calico extension tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_calico_enabled]] <<input_calico_enabled,calico_enabled>>
|Whether to install calico for network pod security policy. NOTE: Provided only as a convenience and not supported by or sourced from Oracle - use at your own risk.
|`bool`
|`false`
|no

|[[input_calico_helm_values]] <<input_calico_helm_values,calico_helm_values>>
|Map of individual Helm chart values. See https://registry.terraform.io/providers/hashicorp/helm/latest/docs/data-sources/template.
|`map(string)`
|`{}`
|no

|[[input_calico_helm_values_files]] <<input_calico_helm_values_files,calico_helm_values_files>>
|Paths to a local YAML files with Helm chart values (as with `helm install -f` which supports multiple). Generate with defaults using `helm show values [CHART] [flags]`.
|`list(string)`
|`[]`
|no

|[[input_calico_helm_version]] <<input_calico_helm_version,calico_helm_version>>
|Version of the Helm chart to install. List available releases using `helm search repo [keyword] --versions`.
|`string`
|`"3.25.0"`
|no

|[[input_calico_mode]] <<input_calico_mode,calico_mode>>
|The type of Calico manifest to install. The default of 'policy-only' is recommended.
|`string`
|`"policy-only"`
|no

|[[input_calico_mtu]] <<input_calico_mtu,calico_mtu>>
|Interface MTU for Calico device(s) (0 = auto).
|`number`
|`0`
|no

|[[input_calico_namespace]] <<input_calico_namespace,calico_namespace>>
|Kubernetes namespace for deployed resources.
|`string`
|`"network"`
|no

|[[input_calico_staging_dir]] <<input_calico_staging_dir,calico_staging_dir>>
|Directory on the operator instance to stage Calico install files.
|`string`
|`"/tmp/calico_install"`
|no

|[[input_calico_typha_enabled]] <<input_calico_typha_enabled,calico_typha_enabled>>
|Whether to enable Typha (automatically enabled for > 50 nodes).
|`bool`
|`false`
|no

|[[input_calico_typha_replicas]] <<input_calico_typha_replicas,calico_typha_replicas>>
|The number of replicas for the Typha deployment (0 = auto).
|`number`
|`0`
|no

|[[input_calico_url]] <<input_calico_url,calico_url>>
|Optionally override the Calico manifest URL (empty string = auto).
|`string`
|`""`
|no

|[[input_calico_version]] <<input_calico_version,calico_version>>
|The version of Calico to install.
|`string`
|`"3.24.1"`
|no

|===

==== Cilium (`cilium_enabled = true`)

NOTE: Pending validation on 5.x

_See https://docs.cilium.io/en/stable/installation/k8s-install-helm[Installation using Helm]._

.Cilium extension tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_cilium_enabled]] <<input_cilium_enabled,cilium_enabled>>
|Whether to deploy the Cilium Helm chart. See https://docs.cilium.io. NOTE: Provided only as a convenience and not supported by or sourced from Oracle - use at your own risk.
|`bool`
|`false`
|no

|[[input_cilium_helm_values]] <<input_cilium_helm_values,cilium_helm_values>>
|Map of individual Helm chart values. See https://registry.terraform.io/providers/hashicorp/helm/latest/docs/data-sources/template.
|`map(string)`
|`{}`
|no

|[[input_cilium_helm_values_files]] <<input_cilium_helm_values_files,cilium_helm_values_files>>
|Paths to a local YAML files with Helm chart values (as with `helm install -f` which supports multiple). Generate with defaults using `helm show values [CHART] [flags]`.
|`list(string)`
|`[]`
|no

|[[input_cilium_helm_version]] <<input_cilium_helm_version,cilium_helm_version>>
|Version of the Helm chart to install. List available releases using `helm search repo [keyword] --versions`.
|`string`
|`"1.13.0"`
|no

|[[input_cilium_namespace]] <<input_cilium_namespace,cilium_namespace>>
|Kubernetes namespace for deployed resources.
|`string`
|`"network"`
|no

|===

==== Multus (`multus_enabled = true`)

_See https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/docs/quickstart.md[Multus Quickstart Guide]._

.Multus extension tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required 

|[[input_multus_daemonset_url]] <<input_multus_daemonset_url,multus_daemonset_url>>
|The URL path to the Multus manifest. Leave unset for tags of https://github.com/k8snetworkplumbingwg/multus-cni using multus_version.
|`string`
|`null`
|no

|[[input_multus_enabled]] <<input_multus_enabled,multus_enabled>>
|Whether to deploy Multus. See https://github.com/k8snetworkplumbingwg/multus-cni. NOTE: Provided only as a convenience and not supported by or sourced from Oracle - use at your own risk.
|`bool`
|`false`
|no

|[[input_multus_namespace]] <<input_multus_namespace,multus_namespace>>
|Kubernetes namespace for deployed resources.
|`string`
|`"network"`
|no

|[[input_multus_version]] <<input_multus_version,multus_version>>
|Version of Multus to install. Ignored when an explicit value for multus_daemonset_url is provided.
|`string`
|`"3.9.3"`
|no

|===

== Network Security Policy

.See also:
* https://kubernetes.io/docs/concepts/services-networking/network-policies/[Network Policies]
* https://kubernetes.io/docs/tasks/administer-cluster/network-policy-provider/[Install a Network Policy Provider]

== Dynamic Routing Gateways (DRGs)

NOTE: Pending validation on 5.x

.See also:
* https://docs.oracle.com/en-us/iaas/Content/Network/Tasks/managingDRGs.htm[Dynamic Routing Gateways (DRGs)]

.DRG tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required

|[[input_create_drg]] <<input_create_drg,create_drg>>
|whether to create Dynamic Routing Gateway. If set to true, creates a Dynamic Routing Gateway and attach it to the VCN.
|`bool`
|`false`
|no

|[[input_drg_attachments]] <<input_drg_attachments,drg_attachments>>
|DRG attachment configurations.
|`any`
|`{}`
|no

|[[input_drg_display_name]] <<input_drg_display_name,drg_display_name>>
|(Updatable) Name of Dynamic Routing Gateway. Does not have to be unique.
|`string`
|`"drg"`
|no

|[[input_drg_id]] <<input_drg_id,drg_id>>
|ID of an external created Dynamic Routing Gateway to be attached to the VCN.
|`string`
|`null`
|no

|===

== Web Application Firewall (WAF)

NOTE: Pending validation on 5.x

You can monitor and protect the load balancers created by OKE using {uri-oci-waf}[OCI Web Application Firewall].

If you would like to monitor and protect your application with OCI Web Application firewall, set `enable_waf = true` *_after_* the cluster has been created. In other words, you need to run `terraform apply` twice. In the first `terraform apply`, `enable_waf` should be set to `false` while the VCN and other resources are created. You can then set `enable_waf=true` and run `terraform apply` again.

You will then need to:

. add the WAF NSG to the load balancer. Refer to the example in {uri-topology}#using-public-load-balancers[Topology - Using Public Load Balancers] for an example
. {uri-oci-waf-policy}[create a WAF Policy]
. {uri-oci-waf-dns}[Update your DNS records to enable WAF]

You may also need to {uri-oci-waf-certificate}[upload your certificate and key].

Follow this {uri-oci-waf-tutorial}[tutorial] on WAF to configure your policy and update your DNS record.

****
N.B. 

. It is good and recommended practice to monitor and protect your application using WAF.
. WAF protection currently only works if you use a public load balancer as a front end to your services. This means that services deployed as NodePort services are currently *not protected* by WAF.
****

.WAF tfvars
[cols="a,a,a,a,a",options="header,autowidth"]
|===
|Name |Description |Type |Default |Required

|[[input_enable_waf]] <<input_enable_waf,enable_waf>>
|Whether to enable WAF monitoring of load balancers.
|`bool`
|`false`
|no

|===
